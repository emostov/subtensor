FROM alpine:3.15.0

# metadata
ARG VCS_REF
ARG BUILD_DATE
ARG SNAPSHOT_DIR
ARG SNAPSHOT_FILE

# This is being set so that no interactive components are allowed when updating.
ARG DEBIAN_FRONTEND=noninteractive

LABEL ai.opentensor.image.authors="operations@opentensor.ai" \
        ai.opentensor.image.vendor="Opentensor Foundation" \
        ai.opentensor.image.title="opentensor/subtensor" \
        ai.opentensor.image.description="Opentensor Subtensor Blockchain" \
        ai.opentensor.image.revision="${VCS_REF}" \
        ai.opentensor.image.created="${BUILD_DATE}" \
        ai.opentensor.image.documentation="https://opentensor.gitbook.io/bittensor/"

# Install bash
RUN apk add --no-cache bash

# show backtraces
ENV RUST_BACKTRACE 1

# install tools and dependencies
RUN apk add --update-cache \
                libssl1.1 \
                ca-certificates \
                git \
                curl 

RUN apk add --no-cache libstdc++ 

# Install rustup
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y 

# Clone subtensor latest
#RUN git clone https://github.com/opentensor/subtensor_exodus.git subtensor

RUN mkdir -p /subtensor/scripts
COPY subtensor/scripts/init.sh /subtensor/scripts

ENV PATH="/root/.cargo/bin:${PATH}"

RUN chmod +x /subtensor/scripts/init.sh

# Overwrite old init.sh
#COPY subtensor/scripts/init.sh subtensor/scripts/init.sh

RUN cat ./subtensor/scripts/init.sh

# Run init script
RUN /bin/sh -c "./subtensor/scripts/init.sh"

# Copy local subtensor
COPY subtensor/target/release/node-subtensor /subtensor

#RUN ls /subtensor/
#RUN /subtensor/node-subtensor --version
